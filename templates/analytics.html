<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据分析 - 公安内网系统</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <h1 class="text-2xl font-bold mb-6">数据分析</h1>

        <!-- 提示消息 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="bg-{{ 'green-100 text-green-700' if category == 'success' else 'red-100 text-red-700' }} p-4 rounded-lg mb-6">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- 加载状态 -->
        <div id="loading" class="bg-yellow-100 text-yellow-700 p-4 rounded-lg mb-6 hidden">
            正在加载数据，请稍候...
        </div>
        <div id="error" class="bg-red-100 text-red-700 p-4 rounded-lg mb-6 hidden">
            无法加载分析数据，请稍后重试或联系管理员。
        </div>

        <!-- 筛选表单 -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">数据筛选</h2>
            <form method="POST" class="space-y-4">
                {{ form.hidden_tag() }}
                {% if current_user.role == 'admin' %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">部门</label>
                    {{ form.department(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                </div>
                {% endif %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">时间范围</label>
                    {{ form.time_range(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                </div>
                {{ form.submit(class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600") }}
            </form>
        </div>

        <!-- 图表区域 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 警情趋势 -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">警情趋势</h2>
                <canvas id="incidentTrendChart"></canvas>
            </div>
            <!-- 案件状态分布 -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">案件状态分布</h2>
                <canvas id="caseStatusChart"></canvas>
            </div>
            <!-- 部门案件数 -->
            <div class="bg-white p-6 rounded-lg shadow-md col-span-1 md:col-span-2">
                <h2 class="text-xl font-semibold mb-4">部门案件数</h2>
                <canvas id="departmentCasesChart"></canvas>
            </div>
        </div>

        <!-- 导出按钮 -->
        <div class="mt-6">
            <a id="exportBtn" href="#" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">导出统计数据 (CSV)</a>
        </div>

        <a href="{{ url_for('index') }}" class="mt-6 inline-block text-blue-500 hover:underline">返回首页</a>
    </div>

    <script>
        // 显示加载状态
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        function showLoading(show) {
            loadingDiv.classList.toggle('hidden', !show);
            errorDiv.classList.add('hidden');
        }
        function showError(message) {
            loadingDiv.classList.add('hidden');
            errorDiv.textContent = message || '无法加载分析数据，请稍后重试或联系管理员。';
            errorDiv.classList.remove('hidden');
        }

        // 获取筛选参数
        const timeRange = '{{ time_range }}';
        const department = '{{ department }}';
        const exportUrl = `/api/export-analytics?time_range=${timeRange}${department ? '&department=' + encodeURIComponent(department) : ''}`;
        document.getElementById('exportBtn').href = exportUrl;

        // 加载分析数据
        showLoading(true);
        fetch(`/api/analytics-stats?time_range=${timeRange}${department ? '&department=' + encodeURIComponent(department) : ''}`)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || '服务器错误'); });
                }
                return response.json();
            })
            .then(data => {
                showLoading(false);
                // 警情趋势图
                const incidentCtx = document.getElementById('incidentTrendChart').getContext('2d');
                new Chart(incidentCtx, {
                    type: 'line',
                    data: {
                        labels: data.incident_trend.dates,
                        datasets: [
                            { label: '刑事警情', data: data.incident_trend.criminal, borderColor: '#3b82f6', fill: false },
                            { label: '治安警情', data: data.incident_trend.public_security, borderColor: '#10b981', fill: false }
                        ]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });

                // 案件状态分布图
                const statusCtx = document.getElementById('caseStatusChart').getContext('2d');
                new Chart(statusCtx, {
                    type: 'pie',
                    data: {
                        labels: ['待审批', '已审批', '已结案'],
                        datasets: [{
                            data: [data.case_status.pending, data.case_status.approved, data.case_status.closed],
                            backgroundColor: ['#f87171', '#4ade80', '#60a5fa']
                        }]
                    },
                    options: { responsive: true }
                });

                // 部门案件数图
                const deptCtx = document.getElementById('departmentCasesChart').getContext('2d');
                new Chart(deptCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.department_cases),
                        datasets: [{
                            label: '案件数',
                            data: Object.values(data.department_cases),
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            })
            .catch(error => {
                showLoading(false);
                showError(`加载数据失败: ${error.message}`);
                console.error('加载数据失败:', error);
            });
    </script>
</body>
</html>